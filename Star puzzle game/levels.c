#include "levels.h"
#include <assert.h>
#include <stdio.h>
#include <stdlib.h>

#define WALL_CHAR L'#'
#define TELEPORTER L'\x2592'

wchar_t* level_0[] =
{
	L"#################################################################################################################################################################################",
	L"# *********************#                                                                                     #  *#                                                              #",
	L"#*                    *#                                                                                           ##                                                           #",
	L"#*                    *#                                                                                           *#                                                           #",
	L"#*                    *#                                                                                       #   *#                                                           #",
	L"#*                    *#                                                                                       ######                                                           #",
	L"#*                    *#                                                                                            #                                                           #",
	L"#*                    *#                                                                                            #                                                           #",
	L"#*                    *#                                                                                            #                                                           #",
	L"#**********************                                                                                                                                                         #",
	L"#########################                                                                                           #############################################################",
	L"#*    Collect stars                **************************************#**************************************                                                               *#",
	L"#*                                           You can only move in one direction until you hit a wall.                                                                          *#",
	L"#*  Use arrow keys to                                                                                                                                                          *#",
	L"#*      navigate                                                                                                                                                               *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*                                                                                                                                                                             *#",
	L"#*******************************************************************************************************************************************************************************#",
	L"#################################################################################################################################################################################",
};

wchar_t* level_1[] =
{
	L"#################################################################################################################################################################################",
	L"#                       ***# ************************************************************************************************************************************************   #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                *#                                                                                                                                  #",
	L"#                                           *#                                                                                                                                  #",
	L"##############################################                                                                                                                                ###",
	L"# ************************                  *#                                                                                                                                 *#",
	L"#                          #                 #                                                                                                                                 *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                ##                                                                                                                                 *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"#                          #                                                                                                                                                   *#",
	L"# ************************                    *                                                                                                                               ###",
	L"############################                  #                                                                                                                                *#",
	L"#                        **#                                                                                                                                                   *#",
	L"#                         *#                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                          #                                                                                                                                                    #",
	L"#                                                                                                                                                                               #",
	L"#################################################################################################################################################################################",
};

wchar_t* level_2[] =
{
	L"#################################################################################################################################################################################",
	L"#                                                             #                               *#*   #                                               ********** # ****         # #",
	L"#                        ##                                                                   *#*   #                                                          #                #",
	L"#                        #*                                   *                               *#### #                                                          #               *#",
	L"#                        #*                                                                       # #                                                                          *#",
	L"#                        #*                                   ##################################  # ##                                                         #                #",
	L"#                        #*                                   #                                     #                                                          #                #",
	L"###                      #*                                                                                                                                                     #",
	L"#*                        *                                                                                                                                                     #",
	L"#*#**********************#*                                   # *******************************   #                                                           #               # #",
	L"#################################################################################################################################################### ########### ############## #",
	L"#******                                                                                                                                               ********   #              #",
	L"#     #                                                                                                                                          #  *#                          #",
	L"#*    *#                                                                                                                                         #  *#                          #",
	L"##                                                                                                                                                  *#                          #",
	L"#*    *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#     *                                                                                                                                             *#                          #",
	L"#*                                                                                                                                                  *#                          #",
	L"#######                                                                                                                                             *#                          #",
	L"#      ******************************************************************************************************************************************#  *#                          #",
	L"#* #                                                                                                                                                *#                          #",
	L"#****                                                                                                                                               *#                          #",
	L"# ####################################################################################################################################################                          #",
	L"#                                                                                                                                                  * #                          #",
	L"# ************************************************************************************************************************************************#                             #",
	L"#################################################################################################################################################################################",
};

wchar_t* level_3[] =
{
	L"#################################################################################################################################################################################",
	L"#***************************# ***#*                                                                                                                    *************************#",
	L"#*                              *#*                                                                                                                    ########################*#",
	L"#*                              *#*                                                                                                                    #                    #***#",
	L"#*                              *#*                                                                                                                    #                    # ###",
	L"#* #                            *#***                                                                                                                  #                        #",
	L"##                              *####                                                                                                                  #                        #",
	L"#                                  \x2193#                                                                                                                  #                        #",
	L"#              # #               #  #                                                                                                                  #                        #",
	L"#              **#               # \x2193#                                                                                                                  #                        #",
	L"############################# ####  #                                                                                                                  #                        #",
	L"#**************************    \x2592\x0001\x2190 \x2190#                                                                                                                  #                        #",
	L"#                           # #######                                                                                                                  #                        #",
	L"# ######################### # ***#*                                                                                      #################             #                        #",
	L"#**************************     *                                                                                           *************#             #                        #",
	L"###########################     *#*                                                                                         *************#             #                        #",
	L"#*                              *#*                                                                                     ################ #             #                        #",
	L"#*                              *#*                                                                                                                   ##                        #",
	L"#*                              *#*                                                                                                                        ****************     #",
	L"#*                              *#*                                                                                                                    #                       *#",
	L"#*                              *#*                                                                                                                    #                       *#",
	L"#*                              *#*                                                                                                                    ####################### *#",
	L"#*                              *#****                                                                                                                 #                       ##",
	L"#*                              *######                                                           ##################################### *##            #                        #",
	L"#*                              *                                                                  **************************************#                     *****************#",
	L"#*                              *##                                                               ########################################             #       ##################",
	L"#*                              *#                                                                ****************************************            ##*                       #",
	L"#*                              *#                                                                                                                     #*       *#              #",
	L"#*                              *#                                                                                                                     #*       *#              #",
	L"#*                              *#                                                                                                                     #*       *#             *#",
	L"#*                              *#                                                                                                                     #*       *#             *#",
	L"#                                #                                                                                                                     #*       *#             *#",
	L"#########################################################################################################################################################        #        #######",
	L"#********************************                                                                                                                                #        \x2592\x0001   *#",
	L"#################################################################################################################################################################################",
};

wchar_t* level_4[] =
{
	L"#################################################################################################################################################################################",
	L"#*****************************#              ***#        # ****** #                                                                                                             #",
	L"#                             #                          #                                                                                  \x2592\x0003  ** #                            #",
	L"#                             #                                                                                                             #                                   #",
	L"#                             #                                                                                                             #                                   #",
	L"#                             #                                                                                                             #                                   #",
	L"#                             #                                                                                                             ###                                 #",
	L"#                             #                                                                                                               #                                 #",
	L"# *************************** #                                                                                                          ####                                ####",
	L"#                            ##              ***#                                                *************************************** \x2592\x0004 #                                \x2592\x0002*#",
	L"# ##########################*##*################################### #############################################################################################################",
	L"# # ********************** #******************* \x2592\x0001******************##*   ***************************************   #  ******************** \x2592\x0001                                 *#",
	L"# #                        ###########################################*                                             # #######################                                  *#",
	L"# #                                                                  #*                                                                     #                                  *#",
	L"# #                                                                  #*                                              *#                     #                                  *#",
	L"# #                                                                  #*                                                                     #                                  *#",
	L"# # \x2592\x0002                                                               #*                                                                     #                                  *#",
	L"# ###                                                                #*                                                                     #                                  *#",
	L"#                                                                    #*                             *#               *#                    *#                                  *#",
	L"# #####################################################################                                              *#                    *#                                  *#",
	L"# #\x2592\x0004                                                                *#*                            *                *#                    *#                                  *#",
	L"#                                                                    *#*                            *                *#                    *#*          #*                     ##",
	L"#                                                                    *#*                            *                *#                    *#*          #*                      #",
	L"#                                                                    *#*                            *                *#                    *#*                                  #",
	L"#                                                                    *#******************************             ****#                    *#*                                  #",
	L"#                                                                    ###                          #####################                    *#*                                 *#",
	L"#                                                                                                                                          *#* #######                         *#",
	L"#                                                                                                                                          *#* *******                         *#",
	L"#                                                                                                                                          *#*                                 ##",
	L"#                                                                                                                                          *#*                                  #",
	L"#                                                                                                                                          *#*       #*                         #",
	L"#                                                                                                                              #       *****#**      #*                         #",
	L"#                                                                                                                                      ########      #*                         #",
	L"#                                                                                                                              # *************\x2592\x0003 *** #                          #",
	L"#################################################################################################################################################################################",
};

wchar_t* level_5[] =
{
	L"#################################################################################################################################################################################",
	L"#****************************************  #********#        \x2592\x0002# \x2592\x0003******************************#\x2592\x0004                                                                           *#",
	L"#*                   *          ########## #*     ###      *####################################*###                                                                           *#",
	L"#*                   *                  *# #*     #**      *#                                  #*#*                                                                            *#",
	L"#*                   *                  *# #*    ##*       *#                                  #*#*                                                                            *#",
	L"#*                   *                  *#  *     #*       *#                                  #*#*                                                                            *#",
	L"#*                   *                  *# #*     #*       *#                                  #*#*                                                                            *#",
	L"#*                   *                  *# #*     #*       *#                                  #*#*                                                                            *#",
	L"#*                   *                  *# #*     #*       *#                                  #*#*                                                                            *#",
	L"#*                   *                  *# #*     #*********#                                  #*#******************************************************************************#",
	L"#####################*#################### #*     #*############################################ ######################################################## #######################",
	L"###                                 \x2592\x0003#### #*      ********************************************   ****************************************************** \x2592\x0001******************** #",
	L"#\x2592\x0002                   #                           # ############################################ ######################################################## #######################",
	L"#############################################               #                                  #*#                                                      #*#                     #",
	L"#*******************************************               ##                                  #*#                                                      #*#                     #",
	L"#*                                                         *#                                  #*#                                                      #*#                     #",
	L"#*                                                         *#                                  #*#                                           ############*#######################",
	L"#*                                                         *#                                  #*#                                           #**********************************#",
	L"#*                                                         *#                                  #*#                                           #*                                *#",
	L"#*                                          #              *#                                  #*#                                           #*                                *#",
	L"################################################### ############################################*#############################################*                                *#",
	L"#                                                    ****************************************************************************************#*                                *#",
	L"# ################################################# #****************************************************************************************                                  *#",
	L"# #                                               # ##########################################################################################*                                ##",
	L"# #                                                \x2592\x0001                                                                              #         ####################################",
	L"# #                                              ## ##############################################                                           #                                  #",
	L"# #                                               #         #                #                   #                                           #                                  #",
	L"# #  *******************************************     *****    **************   *****************                                    ******* ##                                  #",
	L"# #                                               #         #                #                   ##                                          #                                  #",
	L"# #                                               #         #                #                   #*                                          #                                  #",
	L"# #                                               #         #                #                   #*                                          #                                  #",
	L"#                                               \x2592\x0004#         #                #                   #*                                       # ##                                  #",
	L"# ################################################################################################                                 ##     #  #                                  #",
	L"#                                                                                                                                            #                                  #",
	L"#################################################################################################################################################################################",
};

wchar_t* level_6[] =
{
	L"#################################################################################################################################################################################",
	L"# ***********************************************************#                                                                                                             \x2592\x0001#\x2592\x0002#",
	L"#*                                                          *#*                                                                                                        ####### ##",
	L"#*                                                          *#*                                                                                                             *# ##",
	L"#*                                                          *#*                                                                                                             *# ##",
	L"#*                                                          *#************************************************************************************************************* *# ##",
	L"#*                                                          *# ############################################################################################################ ## ##",
	L"#*                                                                                                                                                                             ##",
	L"###########################################################################################################################################################################*#####",
	L"#**#                              ##              #********* # ************************* #\x2592\x0003 # **************************************************                         #*#   #",
	L"#*                                                                                      *#                                                                                #*#   #",
	L"#*                                #                                                     *#                                                                                #*#   #",
	L"#*                                #                                                     *#                                                                                #*#   #",
	L"#*                                #                                                     *#             #*                                                         ******* #*#####",
	L"#**#                              #                                                     *#             #*                                                        ##########*#   #",
	L"## #                              #                                                     *#             #*****                                                     **********#   #",
	L"#                                 #                        # #                          *#             ######                                                                   #",
	L"#                                 #                        # #                          *#                                                                                      #",
	L"#*****                                                     # ##                          #                                                                                      #",
	L"#######                           #                        #\x2592\x0003# ************************ #                                                                                      #",
	L"#                                 # ########################### ##########################                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"#                                 #*                                                    *#                                                                                      #",
	L"# ##                              #*                                                    *#                                                                                      #",
	L"#\x2592\x0002#                              # **************************************************** #                                                       #                              #",
	L"#################################################################################################################################################################################",
	L"#\x2592\x0001       EXIT ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     ---->     *#",
	L"#################################################################################################################################################################################",
};

wchar_t* level_end[] =
{
	L"#################################################################################################################################################################################",
	L"#                                                 #           #                          #             #                                                                        #",
	L"#                                                                                                                                                                               #",
	L"#                                           ##         ###         ##   ########   ####     ##   ####     ##   ###########   #########                                          #",
	L"#                                            ##       ## ##       ##       ##      ## ##    ##   ## ##    ##   ##            ##       ##                                        #",
	L"#                                             ##     ##   ##     ##        ##      ##  ##   ##   ##  ##   ##   ##            ##       ##                                        #",
	L"#                                              ##   ##     ##   ##         ##      ##   ##  ##   ##   ##  ##   ###########   #########                                          #",
	L"#                                               ## ##       ## ##          ##      ##    ## ##   ##    ## ##   ##            ##      ##                                         #",
	L"#                                                ###         ###           ##      ##     ####   ##     ####   ##            ##       ##                                        #",
	L"#                                                 #           #         ########   ##      ###   ##      ###   ###########   ##        ##                                       #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                       #           Thank you for playing this short little puzzle game!           #                                            #",
	L"#                                                       ############################################################################                                            #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                                                                                                                                               #",
	L"#                                                       #                                                                          #                                            #",
	L"#################################################################################################################################################################################",
};

static struct level* loaded_level = NULL;

struct level levels[] =
{
	{ level_0,   L"Moonbase Alpha",   ARRAYSIZE(level_0),   1, 1, 0, 0 },
	{ level_1,   L"Research Lab A",   ARRAYSIZE(level_1),   1, 1, 0, 0 },
	{ level_2,   L"Research Lab B",   ARRAYSIZE(level_2),   1, 1, 0, 0 },
	{ level_3,   L"Reactor Entrance", ARRAYSIZE(level_3),   1, 1, 0, 0 },
	{ level_4,   L"Reactor",		  ARRAYSIZE(level_4),   1, 1, 0, 0 },
	{ level_5,   L"Coolant Halls",	  ARRAYSIZE(level_5),   1, 1, 0, 0 },
	{ level_6,   L"Exit",			  ARRAYSIZE(level_6),   1, 1, 0, 0 },
	{ level_end, L"WINNER WINNER",    ARRAYSIZE(level_end), 1, 1, 0, 0 },
};

#define LEVELS ARRAYSIZE(levels)

/* This function counts the stars, teleporters and their positons. */
void CountGeometry(struct level* pLevel)
{
	for (size_t y = 0; y < pLevel->level_size; ++y) {
		wchar_t* y_wall = pLevel->level[y];
		for (size_t x = 0; x < lstrlenW(y_wall); ++x) {
			if (y_wall[x] == L'*') /* if its a star, increment the counter. */
				pLevel->num_stars++;
			else if (y_wall[x] == TELEPORTER) { /* if its a teleporter, save its position. */
				unsigned short teleId = y_wall[++x]; /* The char next to the teleporter char is the teleporter id. */
				assert(teleId < MAX_TELEPORTERS); /* Make sure its in range. */
				
				/* We want to make sure that we save endpoint A and B. */
				if (pLevel->teleporters[teleId].a.x == 0 && pLevel->teleporters[teleId].a.y == 0) {
					pLevel->teleporters[teleId].a.x = (LONG) x - 1;
					pLevel->teleporters[teleId].a.y = (LONG) y;
				}
				else {
					pLevel->teleporters[teleId].b.x = (LONG) x - 1;
					pLevel->teleporters[teleId].b.y = (LONG) y;
				}
			}
		}
	}
}

struct level* load_level(int level)
{
	/* If a level is already loaded, delete it from memory. *we dont want to cause a memory leak* */
	if (loaded_level != NULL) {
		destroy_current_level();
	}

	assert(level < LEVELS && level >= 0);
	struct level* pLevel = malloc(sizeof(struct level)); /* Allocate space for the level. */
	if (pLevel == NULL) {
		fwprintf(stderr, L"Out of memory.");
		exit(EXIT_FAILURE);
	}

	struct level* pLevelStatic = &levels[level];
	memset(pLevel->teleporters, 0, sizeof(struct Teleporter) * MAX_TELEPORTERS); /* Make sure the array of teleporters is empty. \*/
	memcpy(pLevel, pLevelStatic, sizeof(struct level)); /* Copy all the data from the level into our new structure, we do this so that we can update pixels on the level. */
	pLevel->level = (wchar_t**) calloc(pLevelStatic->level_size, sizeof(wchar_t*)); /* We need to allocate space for the level bitmap itself. So we allocate a 2d array for that. */
	if (pLevel->level == NULL) {
		fwprintf(stderr, L"Out of memory.");
		exit(EXIT_FAILURE);
	}
	
	/* Then we copy all the level data into our 2d buffer. */
	for (size_t i = 0; i < pLevelStatic->level_size; ++i) {
		const size_t wall_size = lstrlenW(pLevelStatic->level[i]);
		pLevel->level[i] = calloc(wall_size + 1, sizeof(wchar_t));
		if (pLevel->level[i] == NULL) {
			fwprintf(stderr, L"Out of memory.");
			exit(EXIT_FAILURE);
		}

		memset(pLevel->level[i], 0, sizeof(wchar_t) * (wall_size + 1));
		memcpy(pLevel->level[i], pLevelStatic->level[i], wall_size * sizeof(wchar_t));
	}

	/* We want to count the number of stars and teleporters. */
	/* This also will fill the teleporter positions. */
	CountGeometry(pLevel);
	loaded_level = pLevel; /* Update the current level. */
	loaded_level->level_id = level; /* Update the level id. */
	return pLevel; 
}

void destroy_current_level()
{
	if (loaded_level != NULL) {
		for (size_t i = 0; i < loaded_level->level_size; ++i) {
			free(loaded_level->level[i]);
		}

		free(loaded_level->level);
		free(loaded_level);
		loaded_level = NULL;
	}
}

struct level* current_level()
{
	return loaded_level;
}

BOOL position_in_bounds(struct level* pLevel, int player_x, int player_y)
{
	if (player_y < 0 || player_x < 0)
		return FALSE;
	if (player_y > (int) pLevel->level_size)
		return FALSE;

	wchar_t* y_wall = pLevel->level[player_y];
	if (player_x > lstrlenW(y_wall))
		return FALSE;

	if (y_wall[player_x] == WALL_CHAR)
		return FALSE;
	
	return TRUE;
}

wchar_t get_level_geometry_at(struct level* pLevel, int x, int y)
{
	if (!pLevel)
		return WALL_CHAR;

	if (x < 0 || y < 0)
		return WALL_CHAR;

	if (y > pLevel->level_size)
		return WALL_CHAR;

	wchar_t* y_wall = pLevel->level[y];
	if (x > lstrlenW(y_wall))
		return WALL_CHAR;

	return y_wall[x];
}

BOOL is_star(struct level* pLevel, int x, int y)
{
	return get_level_geometry_at(pLevel, x, y) == L'*';
}

BOOL PutLevelString(ConsoleGame_t* game, wchar_t* str, size_t len, int x, int y)
{
	if (!game || !str)
		return FALSE;

	/* Don't print anything if the string is empty, but don't error either. */
	if (len == 0)
		return TRUE;

	for (size_t i = 0; i < len; ++i) {
		PutPixel(game, str[i], x + (int)i, y);

		/* We don't want to display the teleporter id as a unicode character, then it would make the game have a ugly pixel. */
		if (str[i] == TELEPORTER) {
			++i;
			continue;
		}
	}

	return TRUE;
}

void display_level(ConsoleGame_t* game, struct level* pLevel)
{
	assert(game && pLevel);

	for (size_t i = 0; i < pLevel->level_size; ++i) {
		PutLevelString(game, pLevel->level[i], (int) lstrlenW(pLevel->level[i]), 0, (int) i);
	}
}

void CheckAndCollectStar(ConsoleGame_t* game, struct level* pLevel, float* pplayer_x, float* pplayer_y, int* score, enum move_direction* direction)
{
	assert(game && pLevel && score && pplayer_x && pplayer_y);
	int player_x = (int) *pplayer_x;
	int player_y = (int) *pplayer_y;

	/* If its a star, collect it and increment the score. */
	if (is_star(pLevel, player_x, player_y)) {
		wchar_t* y_wall = pLevel->level[player_y];
		y_wall[player_x] = L' ';
		++(*score);
	}

	/* If the player collected all the stars, load the next level. */
	if (*score >= pLevel->num_stars && pLevel->num_stars != 0) {
		if (pLevel->level_id + 1 > LEVELS) {
			destroy_current_level();
			DestroyGame(game);
			wprintf(L"No levels remaining!!\n");
			exit(EXIT_SUCCESS);
		}

		/* Reset the score. */
		*score = 0;

		/* Load next level */
		/* If the player won the game, we don't really care about changing their position. */
		/* However, if we're loading a new level, we don't want them to end up at a random position. */
		struct level* level = load_level(pLevel->level_id + 1);
		if (level->level_id != LEVELS - 1) {
			*pplayer_x = (float) level->spawn_x;
			*pplayer_y = (float) level->spawn_y; 
			*direction = DORMANT; /* Make sure to cancel their movement. */
		}
	}
}

#define TELEPORTER_DISTANCE 1

/* This was absolutely painful to implement. :( */
void AttemptTeleport(ConsoleGame_t* game, struct level* pLevel, float* player_x, float* player_y, enum move_direction direction)
{
	assert(game && pLevel && player_x && player_y);

	if (get_level_geometry_at(pLevel, (int) *player_x, (int) *player_y) == TELEPORTER) {
		/* I store the id of the teleporter as a wchar_t right beside the teleporter character. I just made it invisible ;) */
		unsigned short teleId = (unsigned short)get_level_geometry_at(pLevel, (int)(*player_x) + 1, (int)*player_y);
		struct Teleporter* link = &pLevel->teleporters[teleId];
		POINT destination;
		
		/* Which of the two endpoints did we go to, we obviously want to go the opposite endpoint. */
		if (link->a.x == (int) *player_x && link->a.y == (int) *player_y) 
			destination = link->b;
		else destination = link->a;

		switch (direction) {
		case UP:
			if (position_in_bounds(pLevel, destination.x, destination.y - TELEPORTER_DISTANCE)) {
				destination.y -= TELEPORTER_DISTANCE;
			}
		
			break;
		case DOWN:
			if (position_in_bounds(pLevel, destination.x, destination.y + TELEPORTER_DISTANCE)) {
				destination.y += TELEPORTER_DISTANCE;
			}
		
			break;
		case LEFT:
			if (position_in_bounds(pLevel, destination.x - TELEPORTER_DISTANCE, destination.y)) {
				destination.x -= TELEPORTER_DISTANCE;
			}
			break;
		case RIGHT:
			if (position_in_bounds(pLevel, destination.x + TELEPORTER_DISTANCE, destination.y)) {
				destination.x += TELEPORTER_DISTANCE;
			}
		
			break;
		}

		*player_x = (float)destination.x;
		*player_y = (float)destination.y;
	}
}
